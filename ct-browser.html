<!doctype html>
<html>
<head>
<title>ConstraintTree browser</title>
<script type="module">
  import {h, Component, render, createContext } from 'https://esm.sh/preact';
  import { useContext, useState } from 'https://esm.sh/preact/hooks';
  import htm from 'https://esm.sh/htm';
  const html = htm.bind(h);

  const GlobalState = createContext(null);

  function TreeVarRef(props) {
    const {r} = props;
    if(r==0)
      return html`<span class="var treevar" style="background-color: hsl(0, 0%, 20%);">${props.children}</span>`;
    else
      return html`<span class="var treevar" style="background-color: hsl(${360*r}, 20%, 25%);">${props.children}</span>`;
  }

  function ValRef(props) {
    const {r} = props;
    if(r==0)
      return html`<span class="var" style="background-color: hsl(0, 0%, 55%);">${props.children}</span>`;
    else
      return html`<span class="var" style="background-color: hsl(${360*r}, 80%, 66%);">${props.children}</span>`;
  }

  function SubRef(props) {
    const {r} = props;
    if(r==0)
      return html`<span class="var qvar" style="background-color: hsl(0, 0%, 55%);">${props.children}</span>`;
    else
      return html`<span class="var qvar" style="background-color: hsl(${360*r}, 80%, 66%);">${props.children}</span>`;
  }

  function Variables(props) {
    const {tree} = useContext(GlobalState);
    const {maxvar} = tree.data;
    const {type, vars} = props;

    var res = [];

    if(type=='tree') {
      for(var i=0; i<=maxvar; ++i)
        if(vars.has(i))
          res.push(html`
            <td key=${i}><${TreeVarRef} r=${i/maxvar}></></td>
          `);
        else
          res.push(html`<td key=${i}></td>`);
    } else if(type=='lin') {
      for(var i=0; i<=maxvar; ++i)
        if(vars.has(i))
          res.push(html`
            <td key=${i}><${ValRef} r=${i/maxvar}>${vars.get(i)}</></td>
          `);
        else
          res.push(html`<td key=${i}></td>`);
    } else if(type=='quad') {
      for(var i=0; i<=maxvar; ++i)
        if(vars.has(i)) {
          var sub=[];
          vars.get(i).forEach((v,k) => sub.push(html`<${SubRef} r=${k/maxvar}>${v}</>`));
          res.push(html`<td key=${i}><${ValRef} r=${i/maxvar}>${sub}</></td>`);
        } else
          res.push(html`<td key=${i}></td>`);
    }
    //return res;
    return html`${res}`;
  }

  function Bound(props) {
    const {type, bound} = props;
    const sym = type == 'tree' ? "ðŸ—€" : type == 'lin' ? "âŸ‹" : type == 'quad' ? "â—‹" : "?";
    if(!bound) return sym;
    else if(bound.length == 1) return `${sym} = ${bound[0]}`;
    else if(bound.length == 2) return `${bound[0] == null ? "-âˆž" : bound[0]} â‰¤ ${sym} â‰¤ ${bound[1] == null ? "âˆž" : bound[1]}`;
    else return `?${sym}?`;
  }

  function Browser(props) {
    const {tree} = useContext(GlobalState);
    function tableRow(item) {
      return html`<tr key=${item.id}>
        <td>
          <span style="padding-left: ${item.lvl}em">
            ${item.name}
          </span>
        </td>
        <td>
          <${Bound} type=${item.type} bound=${'bound' in item ? item.bound : null} />
        </td>
        <${Variables} type=${item.type} vars=${item.vars} />
      </tr>`;
    }
    return html`<table>${tree.data.rows.map(tableRow)}</table>`;
  }

  function processInput(json) {
    var max_var = 0;
    var items = [];

    function lin_vals(arr, pset) {
      var res=new Map();
      arr.map(x => {
        res.set(x[0], x[1]);
        pset.add(x[0]);
      });
      return res;
    }

    function quad_vals(arr, pset) {
      var res=new Map();
      arr.map(x => {
        const v1=x[0][0], v2=x[0][1], w=x[1];
        if(res.has(v1)) res.get(v1).set(v2, w);
        else res.set(v1, new Map([[v2,w]]));
        if(res.has(v2)) res.get(v2).set(v1, w);
        else res.set(v2, new Map([[v1,w]]));
        pset.add(v1);
        pset.add(v2);
      });
      return res;
    }

    function walkTree(js, lvl, pid, id, name, pset) {
      if('tree' in js) {
        var vs = new Set();
        items.push({type: "tree",
          lvl:lvl, pid: pid, id: id, name: name,
          vars: vs
        });
        Object.keys(js.tree).sort().map(cid => walkTree(js.tree[cid], lvl+1, id, id+'/'+cid, cid, vs));
        for(var v of vs) pset.add(v);
      } else {
        if('lin' in js.value)
          items.push({
            type: "lin",
            lvl:lvl, pid: pid, id: id, name: name,
            bound: js.bound,
            value: js.value.lin,
            vars: lin_vals(js.value.lin, pset)
          });
        else
          items.push({
            type: "quad",
            lvl:lvl, pid: pid, id: id, name: name,
            bound: js.bound,
            value: js.value.quad,
            vars: quad_vals(js.value.quad, pset)
          });
      }
    }

    var s = new Set();
    walkTree(json, 0, '', '', '/', s);

    console.log(items);
    return {rows: items, maxvar: Math.max(...s)};
  }

  function App(props) {
    const [tree, setTree] = useState(null);

    const loadState = function(event) {
      var input = event.target;
      var reader = new FileReader();
      reader.onload = function() {
        setTree({
          filename: input.files[0].name,
          data: processInput(JSON.parse(reader.result))
        });
      };
      reader.readAsText(input.files[0]);
    }

    if(tree)
      return html`<${GlobalState.Provider} value=${{tree:tree, setTree:setTree,}}><h1>ConstraintTree ${tree.filename}</h1><${Browser}/></>`;
    else
      return html`<>
        <h1>ConstraintTree browser</h1>
        <p>Open a constraint tree as exported from <a href="https://github.com/COBREXA/ConstraintTrees.jl">ConstraintTrees.jl</a> package below:</p>
        <div><input type="file" onChange=${loadState}></div>
        <pre># reference export code:
import ConstraintTrees, JSON
open("<strong>YOUR FILE NAME</strong>.json", "w") do f
  write(f, JSON.json(ConstraintTrees.dictify(<strong>YOUR TREE VARIABLE</strong>)))
end</pre>
      </>`;
  }

  const app_elem = document.getElementById("ctb-app");
  app_elem.innerHTML = "";
  render(html`<${App}/>`, app_elem);
</script>
<style type="text/css">
body {
  background: #222;
  color: #ddd;
  font-family: 'sans', 'sans-serif';
}

a {
  color: inherit;
}

a:visited {
  color: inherit;
}

a:hover {
  color: #fff;
}

strong {
  color: #fc4;
}

table {
  border-collapse: collapse;
}

td {
  padding: 0.5em;
  white-space: nowrap;
  border-left: 1px solid #333;
}

tr:nth-child(odd) {
  background: #2a2a2a;
}

span.var {
  min-width: 1em;
  min-height: 1em;
  display: block;
  padding: 0.5em;
  margin: 0.25em;
  border-radius: 0.5em;
  font-size: 80%;
  font-weight: bold;
  color: black;
  text-align: center;
}

span.treevar {
}

span.qvar {
  border: 0.25em solid black;
}

</style>
</head>
<body><div id="ctb-app">This needs javascript.</div></body>
</html>
